# referent
Программа Референт
Project.md - описание проекта

## Установка и запуск

Проект использует pnpm в качестве менеджера пакетов.

### Установка зависимостей
```powershell
pnpm install
```

### Запуск в режиме разработки
```powershell
pnpm dev
```

### Сборка проекта
```powershell
pnpm build
```

### Запуск production версии
```powershell
pnpm start
```

### Линтинг
```powershell
pnpm lint
```

## Проверка работоспособности

### 1. Проверка линтинга и типов
```powershell
pnpm lint
```
Должно вывести: `✔ No ESLint warnings or errors`

### 2. Проверка сборки
```powershell
pnpm build
```
Должна успешно завершиться без ошибок.

### 3. Запуск dev-сервера
```powershell
pnpm dev
```
Сервер запустится на `http://localhost:3000`

### 4. Проверка в браузере
1. Откройте браузер и перейдите на `http://localhost:3000`
2. Должен открыться интерфейс с полем для ввода URL и тремя кнопками:
   - "О чем статья?"
   - "Тезисы"
   - "Пост для Telegram"

### 5. Тестовая проверка API
Можно протестировать API endpoint напрямую:
```powershell
$body = @{ url = "https://example.com/article" } | ConvertTo-Json
Invoke-RestMethod -Uri "http://localhost:3000/api/parse" -Method Post -Body $body -ContentType "application/json"
```
Должен вернуть JSON с полями: `title`, `content`, `date`

### 6. Полная проверка
Все проверки выполняются одной командой:
```powershell
pnpm lint; pnpm build; Write-Host "✓ Все проверки пройдены успешно!"
```

## Деплой на Vercel

### Настройка
Проект готов к деплою на Vercel. Файл `vercel.json` настроен для увеличения таймаута API route до 30 секунд.

### Возможные проблемы и решения

#### Ошибка 403 Forbidden
Если при парсинге некоторых сайтов возникает ошибка "403 Forbidden", это означает, что сайт блокирует автоматические запросы с серверов Vercel.

**Автоматические улучшения:**
- ✅ Система автоматически делает до 3 повторных попыток при ошибке 403
- ✅ Используются разные User-Agent при каждой попытке
- ✅ Экспоненциальная задержка между попытками (1с, 2с, 4с)
- ✅ Более реалистичные заголовки браузера

**Если ошибка все равно возникает:**
1. Попробуйте другой URL статьи
2. Некоторые сайты имеют очень строгую защиту от ботов и могут блокировать все автоматические запросы
3. Проверьте, доступен ли сайт в браузере

#### Таймауты
Если запрос занимает слишком много времени:
- Максимальное время выполнения API route: 30 секунд
- Таймаут fetch запроса: 30 секунд
- Таймаут на клиенте: 60 секунд

#### Улучшения для работы на Vercel
В коде уже реализованы:
- ✅ **Автоматические ретраи** - до 3 попыток при ошибках 403 и таймаутах
- ✅ **Ротация User-Agent** - случайный выбор из 5 различных браузеров
- ✅ **Экспоненциальная задержка** - умная задержка между попытками (1с → 2с → 4с)
- ✅ **Реалистичные заголовки** - полный набор заголовков современного браузера
- ✅ **Обработка таймаутов** - автоматические ретраи при превышении времени ожидания
- ✅ **Детальная обработка ошибок** - информативные сообщения для разных типов ошибок
- ✅ **Валидация URL** - проверка корректности URL перед запросом
- ✅ **Настройка runtime** - использование Node.js runtime для cheerio

### Команды для деплоя
```powershell
# Установка Vercel CLI (если еще не установлен)
pnpm add -g vercel

# Деплой
vercel

# Production деплой
vercel --prod
```